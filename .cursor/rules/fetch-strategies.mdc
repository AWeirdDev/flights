---
description: Guidelines for implementing and working with different fetch strategies
---

# Fetch Strategy Implementation

## Overview
The project supports multiple fetch strategies to handle different scenarios (rate limiting, blocking, regional restrictions, etc.).

## Strategy Files
- [fast_flights/primp.py](mdc:fast_flights/primp.py) & [fast_flights/primp.pyi](mdc:fast_flights/primp.pyi) - Fast HTTP client with browser impersonation (default)
- [fast_flights/fallback_playwright.py](mdc:fast_flights/fallback_playwright.py) - Serverless Playwright fallback
- [fast_flights/local_playwright.py](mdc:fast_flights/local_playwright.py) - Local Playwright implementation
- [fast_flights/bright_data_fetch.py](mdc:fast_flights/bright_data_fetch.py) - Bright Data proxy integration

## Fetch Strategy Pattern
All fetch strategies should:
1. Accept `params: dict` as parameter (containing `tfs`, `hl`, `tfu`, `curr`)
2. Return a `Response` object (or compatible object) with:
   - `.status_code` property
   - `.text` property (HTML content)
   - `.text_markdown` property (for error messages)

## Response Interface
```python
class Response:
    status_code: int
    text: str
    text_markdown: str  # Markdown-formatted version for debugging
```

## When to Use Each Strategy

### primp (default/common mode)
- Fastest option
- Uses browser impersonation to avoid basic detection
- Works for most requests
- No external dependencies beyond the primp library

### Fallback Playwright
- Automatically triggered when primp fails (in fallback mode)
- Uses serverless Playwright functions
- Handles JavaScript rendering and more complex anti-bot measures
- Slower but more reliable

### Local Playwright  
- For development and testing
- Requires local Playwright installation (`pip install fast-flights[local]`)
- Useful for debugging issues with the scraper

### Bright Data
- For production use with proxy service
- Requires Bright Data credentials
- Most reliable but has cost implications

## Error Handling
- Fetch strategies should raise `AssertionError` if status code is not 200
- Core module catches `AssertionError` and falls back to Playwright in fallback mode
- If parsing fails, retry with force-fallback mode to ensure JavaScript rendering

## Adding New Strategies
1. Create a new file in `fast_flights/` (e.g., `my_fetch.py`)
2. Implement a function that accepts `params: dict` and returns `Response`
3. Add the strategy to the mode options in [fast_flights/core.py](mdc:fast_flights/core.py)
4. Update type hints to include the new mode literal
